Empath (
    smtp: (
        listeners: [
            {
                "socket": "[::]:1025",
                "context": {
                    "service": "smtp",
                },
                // Server-side timeout configuration (RFC 5321 compliant defaults)
                // These timeouts prevent resource exhaustion from slow or malicious clients
                "timeouts": (
                    command_secs: 300,          // 5 minutes for regular commands (EHLO, MAIL FROM, etc.)
                    data_init_secs: 120,        // 2 minutes for DATA command
                    data_block_secs: 180,       // 3 minutes between data chunks
                    data_termination_secs: 600, // 10 minutes for processing after final dot
                    connection_secs: 1800,      // 30 minutes maximum session lifetime
                ),
                "extensions": [
                    {
                        "size": 10000,
                    }
                ]
            },
            {
                "socket": "[::]:1026",
                "context": {
                    "service": "smtps",
                },
            },
        ],
    ),

    // FFI module configuration
    // These example modules are built and included in the Docker image
    modules: [
        // Example validation listener module
        // Logs SMTP transaction events with custom formatting
        (
            type: "SharedLibrary",
            name: "/empath/modules/libexample.so",
            arguments: [],
        ),
        // Example event listener module
        // Tracks connection lifecycle and delivery events
        (
            type: "SharedLibrary",
            name: "/empath/modules/libevent.so",
            arguments: [],
        ),
    ],

    spool: (
        type: "File",
        path: "/tmp/spool/empath",
    ),
    delivery: (
        scan_interval_secs: 30,
        process_interval_secs: 10,
        max_attempts: 25,

        // Exponential backoff configuration for retry scheduling
        // Base delay for first retry (in seconds). Subsequent retries double this delay.
        // Default: 60 seconds (1 minute)
        base_retry_delay_secs: 60,

        // Maximum delay between retry attempts (in seconds). Caps exponential growth.
        // Default: 86400 seconds (24 hours)
        max_retry_delay_secs: 86400,

        // Jitter factor for randomizing retry delays (0.0 to 1.0)
        // Adds ±20% randomness to prevent thundering herd. Default: 0.2
        retry_jitter_factor: 0.2,

        // Message expiration time (in seconds)
        // Messages older than this will be marked as expired.
        // Set to None to never expire messages. Default: None
        // Example: 604800 = 7 days
        // message_expiration_secs: 604800,

        // SECURITY WARNING: Accept invalid TLS certificates globally (for testing only)
        // Default: false (secure). Only enable for testing with self-signed certificates.
        // accept_invalid_certs: false,

        // SMTP operation timeout configuration (all values in seconds)
        // These timeouts prevent hung connections and ensure timely failure detection
        smtp_timeouts: (
            connect_secs: 30,      // Initial connection establishment
            ehlo_secs: 30,         // EHLO/HELO commands
            starttls_secs: 30,     // STARTTLS command and TLS upgrade
            mail_from_secs: 30,    // MAIL FROM command
            rcpt_to_secs: 30,      // RCPT TO command (per recipient)
            data_secs: 120,        // DATA command and message transmission (longer for large messages)
            quit_secs: 10,         // QUIT command
        ),

        // Per-domain configuration for testing and custom settings
        domains: {
            // Route test.example.com to local SMTP server for integration testing
            "test.example.com": (
                mx_override: "localhost:1025",
                // Accept self-signed certs for this test domain only
                accept_invalid_certs: true,
            ),
            // Example: Require TLS for a specific domain
            "secure.example.com": (
                require_tls: true,
                max_connections: 5,
                // Explicitly require valid certificates (overrides global setting)
                accept_invalid_certs: false,
            ),
            // Example: Rate limiting for a high-volume domain
            "gmail.com": (
                max_connections: 10,
                rate_limit: 100, // messages per minute
            ),
        },
    ),
    // OpenTelemetry metrics configuration
    // Metrics are pushed to an OpenTelemetry Collector via OTLP/HTTP
    // The Collector can then expose them in Prometheus format for scraping
    // Architecture: Empath MTA → OTLP → OTel Collector → Prometheus → Grafana
    metrics: (
        // Enable/disable metrics collection
        // When disabled, all metrics operations become no-ops with minimal overhead
        enabled: true,

        // OTLP endpoint URL for metrics export
        // Metrics will be pushed to this OpenTelemetry Collector endpoint
        // Common values:
        //   - "http://localhost:4318/v1/metrics" (local development, OTLP HTTP)
        //   - "http://otel-collector:4318/v1/metrics" (Docker Compose, service name)
        // Default: http://localhost:4318/v1/metrics
        // NOTE: When running in Docker Compose, use the service name (otel-collector)
        endpoint: "http://otel-collector:4318/v1/metrics",
    ),
)
