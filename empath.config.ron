Empath (
    smtp: (
        listeners: [
            {
                "socket": "[::]:1025",
                "context": {
                    "service": "smtp",
                },
                // Server-side timeout configuration (RFC 5321 compliant defaults)
                // These timeouts prevent resource exhaustion from slow or malicious clients
                "timeouts": (
                    command_secs: 300,          // 5 minutes for regular commands (EHLO, MAIL FROM, etc.)
                    data_init_secs: 120,        // 2 minutes for DATA command
                    data_block_secs: 180,       // 3 minutes between data chunks
                    data_termination_secs: 600, // 10 minutes for processing after final dot
                    connection_secs: 1800,      // 30 minutes maximum session lifetime
                ),
                "extensions": [
                    {
                        "size": 10000,
                    }
                ]
            },
            {
                "socket": "[::]:1026",
                "context": {
                    "service": "smtps",
                },
            },
        ],
    ),
    spool: (
        type: "File",
        path: "/tmp/spool/empath",
    ),
    delivery: {
        "scan_interval_secs": 30,
        "process_interval_secs": 10,
        "max_attempts": 25,

        // Exponential backoff configuration for retry scheduling
        // Base delay for first retry (in seconds). Subsequent retries double this delay.
        // Default: 60 seconds (1 minute)
        "base_retry_delay_secs": 60,

        // Maximum delay between retry attempts (in seconds). Caps exponential growth.
        // Default: 86400 seconds (24 hours)
        "max_retry_delay_secs": 86400,

        // Jitter factor for randomizing retry delays (0.0 to 1.0)
        // Adds ±20% randomness to prevent thundering herd. Default: 0.2
        "retry_jitter_factor": 0.2,

        // Message expiration time (in seconds)
        // Messages older than this will be marked as expired.
        // Set to None to never expire messages. Default: None
        // Example: 604800 = 7 days
        // message_expiration_secs: 604800,

        // SECURITY WARNING: Accept invalid TLS certificates globally (for testing only)
        // Default: false (secure). Only enable for testing with self-signed certificates.
        // accept_invalid_certs: false,

        // SMTP operation timeout configuration (all values in seconds)
        // These timeouts prevent hung connections and ensure timely failure detection
        "smtp_timeouts": (
            connect_secs: 30,      // Initial connection establishment
            ehlo_secs: 30,         // EHLO/HELO commands
            starttls_secs: 30,     // STARTTLS command and TLS upgrade
            mail_from_secs: 30,    // MAIL FROM command
            rcpt_to_secs: 30,      // RCPT TO command (per recipient)
            data_secs: 120,        // DATA command and message transmission (longer for large messages)
            quit_secs: 10,         // QUIT command
        ),

        // Per-domain configuration for testing and custom settings
        "domains": {
            // Route test.example.com to local SMTP server for integration testing
            "test.example.com": (
                mx_override: "localhost:1025",
                // Accept self-signed certs for this test domain only
                accept_invalid_certs: true,
            ),
            // Example: Require TLS for a specific domain
            "secure.example.com": (
                require_tls: true,
                max_connections: 5,
                // Explicitly require valid certificates (overrides global setting)
                accept_invalid_certs: false,
            ),
            // Example: Rate limiting for a high-volume domain
            "gmail.com": (
                max_connections: 10,
                rate_limit: 100, // messages per minute
            ),
        },
    },
    // OpenTelemetry metrics configuration
    // Metrics are pushed to an OpenTelemetry Collector via OTLP/HTTP
    // The Collector can then expose them in Prometheus format for scraping
    // Architecture: Empath MTA → OTLP → OTel Collector → Prometheus → Grafana
    metrics: (
        // Enable/disable metrics collection
        // When disabled, all metrics operations become no-ops with minimal overhead
        enabled: true,

        // OTLP endpoint URL for metrics export
        // Metrics will be pushed to this OpenTelemetry Collector endpoint
        // Common values:
        //   - "http://localhost:4318/v1/metrics" (local development, OTLP HTTP)
        //   - "http://otel-collector:4318/v1/metrics" (Docker Compose, service name)
        // Default: http://localhost:4318/v1/metrics
        // NOTE: When running in Docker Compose, use the service name (otel-collector)
        endpoint: "http://otel-collector:4318/v1/metrics",
    ),
    // Health check endpoints configuration
    // Provides /health/live and /health/ready endpoints for Kubernetes probes
    health: (
        // Enable/disable health check server
        // When disabled, the health server will not start
        enabled: true,

        // Address to bind the health check server
        // Common values:
        //   - "[::]:8080" (IPv6 any address, port 8080)
        //   - "0.0.0.0:8080" (IPv4 any address, port 8080)
        //   - "127.0.0.1:8080" (localhost only, port 8080)
        // Default: [::]:8080
        listen_address: "[::]:8080",

        // Maximum queue size threshold for readiness probe
        // If the delivery queue exceeds this size, the readiness probe will fail
        // This prevents the service from accepting new traffic when overwhelmed
        // Default: 10000
        max_queue_size: 10000,
    ),
    // Audit logging configuration for compliance and security monitoring
    // Logs all message lifecycle events (received, delivery attempts, success, failure)
    audit: (
        // Enable/disable audit logging
        // When disabled, audit events will not be logged
        // Default: true
        enabled: true,

        // Redact sender email addresses from audit logs (PII protection)
        // When enabled, sender addresses are redacted to [REDACTED]@domain.com
        // Useful for GDPR/HIPAA compliance
        // Default: false (full sender address logged)
        redact_sender: false,

        // Redact recipient email addresses from audit logs (PII protection)
        // When enabled, recipient addresses are redacted to [REDACTED]@domain.com
        // Default: false (full recipient addresses logged)
        redact_recipients: false,

        // Redact message content from audit logs (PII protection)
        // When enabled, message content previews are not included in logs
        // Default: true (content is redacted)
        redact_message_content: true,
    ),
)
